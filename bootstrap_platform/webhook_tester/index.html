<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission IQ - Webhook Testing Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
</head>
<body class="bg-gray-50" x-data="webhookTester()">
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg"></div>
                    <h1 class="text-xl font-bold text-gray-900">Webhook Testing Interface</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">API Key: <code class="bg-gray-100 px-2 py-1 rounded">****_demo</code></span>
                    <a href="/api/docs" class="text-blue-600 hover:text-blue-800 text-sm">API Docs</a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-2 gap-8">
            
            <!-- Configuration Panel -->
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Webhook Configuration</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                            <input 
                                type="url" 
                                x-model="config.url"
                                placeholder="https://your-app.com/webhooks/commission-iq"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            >
                            <p class="text-xs text-gray-500 mt-1">Use webhook.site for testing</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Type</label>
                            <select 
                                x-model="config.eventType"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            >
                                <optgroup label="Policy Events">
                                    <option value="policy.created">policy.created</option>
                                    <option value="policy.updated">policy.updated</option>
                                    <option value="policy.renewed">policy.renewed</option>
                                    <option value="policy.cancelled">policy.cancelled</option>
                                </optgroup>
                                <optgroup label="Commission Events">
                                    <option value="commission.calculated">commission.calculated</option>
                                    <option value="commission.paid">commission.paid</option>
                                    <option value="commission.reconciled">commission.reconciled</option>
                                    <option value="commission.discrepancy">commission.discrepancy</option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">HTTP Method</label>
                            <select 
                                x-model="config.method"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="POST">POST (Recommended)</option>
                                <option value="PUT">PUT</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Custom Headers
                                <span class="text-xs font-normal text-gray-500">(Optional)</span>
                            </label>
                            <textarea 
                                x-model="config.headers"
                                placeholder='{"X-Custom-Header": "value"}'
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>

                        <div>
                            <label class="flex items-center space-x-2">
                                <input 
                                    type="checkbox" 
                                    x-model="config.includeSignature"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                >
                                <span class="text-sm text-gray-700">Include HMAC signature</span>
                            </label>
                        </div>

                        <button 
                            @click="sendWebhook()"
                            :disabled="!config.url || sending"
                            class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                            <span x-show="!sending">Send Test Webhook</span>
                            <span x-show="sending" class="flex items-center justify-center">
                                <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Sending...
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Sample Payloads -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Sample Payloads</h3>
                    
                    <div class="space-y-3">
                        <button 
                            @click="loadSample('policy_created')"
                            class="w-full text-left px-4 py-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                        >
                            <div class="font-medium text-gray-900">New Policy Created</div>
                            <div class="text-sm text-gray-500">Sample policy.created event</div>
                        </button>
                        
                        <button 
                            @click="loadSample('commission_calculated')"
                            class="w-full text-left px-4 py-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                        >
                            <div class="font-medium text-gray-900">Commission Calculated</div>
                            <div class="text-sm text-gray-500">Sample commission.calculated event</div>
                        </button>
                        
                        <button 
                            @click="loadSample('reconciliation_complete')"
                            class="w-full text-left px-4 py-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                        >
                            <div class="font-medium text-gray-900">Reconciliation Complete</div>
                            <div class="text-sm text-gray-500">Sample commission.reconciled event</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="space-y-6">
                <!-- Payload Preview -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Payload Preview</h3>
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre><code class="language-json" x-text="JSON.stringify(getPayload(), null, 2)"></code></pre>
                    </div>
                </div>

                <!-- Response -->
                <div class="bg-white rounded-lg shadow-sm border p-6" x-show="response">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Response</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-gray-700">Status:</span>
                            <span 
                                class="px-3 py-1 rounded-full text-sm font-medium"
                                :class="{
                                    'bg-green-100 text-green-800': response?.status >= 200 && response?.status < 300,
                                    'bg-red-100 text-red-800': response?.status >= 400,
                                    'bg-yellow-100 text-yellow-800': response?.status >= 300 && response?.status < 400
                                }"
                                x-text="response?.status || 'N/A'"
                            ></span>
                            <span class="text-sm text-gray-500" x-text="response?.statusText"></span>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-1">Response Time:</div>
                            <div class="text-sm text-gray-900" x-text="`${response?.time || 0}ms`"></div>
                        </div>
                        
                        <div x-show="response?.headers">
                            <div class="text-sm font-medium text-gray-700 mb-1">Response Headers:</div>
                            <div class="bg-gray-50 rounded p-3 font-mono text-xs">
                                <template x-for="[key, value] in Object.entries(response?.headers || {})" :key="key">
                                    <div><span class="text-gray-600" x-text="`${key}:`"></span> <span x-text="value"></span></div>
                                </template>
                            </div>
                        </div>
                        
                        <div x-show="response?.body">
                            <div class="text-sm font-medium text-gray-700 mb-1">Response Body:</div>
                            <div class="bg-gray-900 rounded-lg p-3 overflow-x-auto">
                                <pre><code class="language-json" x-text="JSON.stringify(response?.body, null, 2)"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Request History -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Request History</h3>
                    
                    <div class="space-y-2" x-show="history.length > 0">
                        <template x-for="(item, index) in history" :key="index">
                            <div 
                                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"
                                @click="loadFromHistory(item)"
                            >
                                <div class="flex items-center space-x-3">
                                    <span 
                                        class="w-2 h-2 rounded-full"
                                        :class="{
                                            'bg-green-500': item.status >= 200 && item.status < 300,
                                            'bg-red-500': item.status >= 400,
                                            'bg-yellow-500': item.status >= 300 && item.status < 400
                                        }"
                                    ></span>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900" x-text="item.eventType"></div>
                                        <div class="text-xs text-gray-500" x-text="item.timestamp"></div>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-500" x-text="`${item.time}ms`"></span>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="history.length === 0" class="text-center text-gray-500 text-sm py-4">
                        No requests yet
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function webhookTester() {
            return {
                config: {
                    url: '',
                    eventType: 'policy.created',
                    method: 'POST',
                    headers: '',
                    includeSignature: true
                },
                response: null,
                sending: false,
                history: [],
                
                getPayload() {
                    const basePayload = {
                        id: `evt_${Date.now()}`,
                        type: this.config.eventType,
                        created: new Date().toISOString(),
                        data: this.getSampleData(this.config.eventType)
                    };
                    
                    if (this.config.includeSignature) {
                        basePayload.signature = 'sha256=' + this.generateSignature();
                    }
                    
                    return basePayload;
                },
                
                getSampleData(eventType) {
                    const samples = {
                        'policy.created': {
                            object: {
                                id: 'pol-12345',
                                policy_number: 'AUTO-789012',
                                customer: 'ABC Insurance Agency',
                                carrier: 'Progressive',
                                type: 'AUTO',
                                premium: 2500.00,
                                commission_rate: 12.5,
                                commission_amount: 312.50,
                                effective_date: '2024-01-15',
                                status: 'active'
                            }
                        },
                        'commission.calculated': {
                            object: {
                                calculation_id: 'calc-67890',
                                policy_id: 'pol-12345',
                                premium: 3000.00,
                                rate: 15.0,
                                gross_commission: 450.00,
                                agent_commission: 225.00,
                                agency_commission: 225.00
                            }
                        },
                        'commission.reconciled': {
                            object: {
                                reconciliation_id: 'recon-11111',
                                period: '2024-01',
                                carrier: 'State Farm',
                                matched_count: 125,
                                discrepancy_count: 3,
                                missing_count: 2,
                                total_variance: 1234.56
                            }
                        }
                    };
                    
                    return samples[eventType] || samples['policy.created'];
                },
                
                generateSignature() {
                    // In real implementation, this would use HMAC-SHA256
                    return btoa(Math.random().toString(36).substring(7));
                },
                
                async sendWebhook() {
                    this.sending = true;
                    this.response = null;
                    
                    const startTime = Date.now();
                    
                    try {
                        // Simulate API call to send webhook
                        const mockResponse = await this.simulateWebhookSend();
                        
                        this.response = {
                            status: mockResponse.status,
                            statusText: mockResponse.statusText,
                            time: Date.now() - startTime,
                            headers: mockResponse.headers,
                            body: mockResponse.body
                        };
                        
                        // Add to history
                        this.history.unshift({
                            eventType: this.config.eventType,
                            status: mockResponse.status,
                            time: this.response.time,
                            timestamp: new Date().toLocaleTimeString(),
                            config: { ...this.config }
                        });
                        
                        // Keep only last 10 items
                        this.history = this.history.slice(0, 10);
                        
                        // Re-highlight code
                        setTimeout(() => Prism.highlightAll(), 100);
                        
                    } catch (error) {
                        this.response = {
                            status: 500,
                            statusText: 'Error',
                            time: Date.now() - startTime,
                            body: { error: error.message }
                        };
                    } finally {
                        this.sending = false;
                    }
                },
                
                async simulateWebhookSend() {
                    // Simulate network delay
                    await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 700));
                    
                    // Simulate different responses
                    const responses = [
                        {
                            status: 200,
                            statusText: 'OK',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Request-ID': `req-${Date.now()}`
                            },
                            body: { 
                                success: true, 
                                message: 'Webhook received successfully',
                                processed_at: new Date().toISOString()
                            }
                        },
                        {
                            status: 202,
                            statusText: 'Accepted',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Queue-ID': `queue-${Date.now()}`
                            },
                            body: { 
                                accepted: true,
                                queue_position: Math.floor(Math.random() * 10) + 1
                            }
                        }
                    ];
                    
                    // 90% success rate
                    if (Math.random() > 0.1) {
                        return responses[Math.floor(Math.random() * responses.length)];
                    } else {
                        throw new Error('Connection timeout');
                    }
                },
                
                loadSample(type) {
                    const samples = {
                        'policy_created': {
                            eventType: 'policy.created',
                            url: 'https://webhook.site/unique-id'
                        },
                        'commission_calculated': {
                            eventType: 'commission.calculated',
                            url: 'https://your-app.com/webhooks/commission-iq'
                        },
                        'reconciliation_complete': {
                            eventType: 'commission.reconciled',
                            url: 'https://your-app.com/api/webhooks'
                        }
                    };
                    
                    const sample = samples[type];
                    if (sample) {
                        this.config.eventType = sample.eventType;
                        if (!this.config.url) {
                            this.config.url = sample.url;
                        }
                    }
                    
                    // Re-highlight code
                    setTimeout(() => Prism.highlightAll(), 100);
                },
                
                loadFromHistory(item) {
                    this.config = { ...item.config };
                },
                
                init() {
                    // Re-highlight on updates
                    this.$watch('config', () => {
                        setTimeout(() => Prism.highlightAll(), 100);
                    });
                }
            }
        }
    </script>
</body>
</html>